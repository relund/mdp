<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="MDP2">
<title>An infinite-horizon HMDP • MDP2</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.2.2/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.2.2/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="An infinite-horizon HMDP">
<meta property="og:description" content="MDP2">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">MDP2</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">2.1.2</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/building.html">Building an MDP model</a>
    <a class="dropdown-item" href="../articles/finite-mdp.html">Solving a finite-horizon semi-MDP</a>
    <a class="dropdown-item" href="../articles/infinite-hmdp.html">An infinite-horizon HMDP</a>
    <a class="dropdown-item" href="../articles/infinite-mdp.html">Solving an infinite-horizon semi-MDP</a>
    <a class="dropdown-item" href="../articles/mdp2.html">The MDP2 package</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/relund/mdp/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>An infinite-horizon HMDP</h1>
                        <h4 data-toc-skip class="author">Lars Relund <a href="mailto:lars@relund.dk" class="email">lars@relund.dk</a>
</h4>
            
            <h4 data-toc-skip class="date">2023-01-27</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/relund/mdp/blob/HEAD/vignettes/infinite-hmdp.Rmd" class="external-link"><code>vignettes/infinite-hmdp.Rmd</code></a></small>
      <div class="d-none name"><code>infinite-hmdp.Rmd</code></div>
    </div>

    
    
<style> 
p {text-align: justify;} 
//.sourceCode {background-color: white;}
pre {
  // border-style: solid;
  // border-width: 1px;
  // border-color: grey;
  //background-color: grey !important;
}
img {
   //width: 100%;
   border: 0;
}
</style>
<!-- scale math down --><script type="text/x-mathjax-config"> 
    MathJax.Hub.Config({ 
        "HTML-CSS": { scale: 80 }
        });
</script><p>The <code>MDP2</code> package in R is a package for solving Markov
decision processes (MDPs) with discrete time-steps, states and actions.
Both traditional MDPs <span class="citation">(Puterman 1994)</span>,
semi-Markov decision processes (semi-MDPs) <span class="citation">(Tijms
2003)</span> and hierarchical-MDPs (HMDPs) <span class="citation">(Kristensen and Jørgensen 2000)</span> can be solved
under a finite and infinite time-horizon.</p>
<p>The package implement well-known algorithms such as policy iteration
and value iteration under different criteria e.g. average reward per
time unit and expected total discounted reward. The model is stored
using an underlying data structure based on the <em>state-expanded
directed hypergraph</em> of the MDP (<span class="citation">Nielsen and
Kristensen (2006)</span>) implemented in <code>C++</code> for fast
running times. <!-- Under development is also
support for MLHMP which is a Java implementation of algorithms for solving MDPs (@Kristensen03). 
--></p>
<p>Building and solving an MDP is done in two steps. First, the MDP is
built and saved in a set of binary files. Next, you load the MDP into
memory from the binary files and apply various algorithms to the
model.</p>
<p>For building the MDP models see <code><a href="../articles/building.html">vignette("building")</a></code>. In
this vignette we focus on the second step, i.e. finding the optimal
policy. Here we consider an infinite-horizon HMDP.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://relund.github.io/mdp/" class="external-link">MDP2</a></span><span class="op">)</span></span></code></pre></div>
<div class="section level2">
<h2 id="an-infinite-horizon-hmdp">An infinite-horizon HMDP<a class="anchor" aria-label="anchor" href="#an-infinite-horizon-hmdp"></a>
</h2>
<p>A hierarchical MDP is an MDP with parameters defined in a special
way, but nevertheless in accordance with all usual rules and conditions
relating to such processes (<span class="citation">Kristensen and
Jørgensen (2000)</span>). The basic idea of the hierarchical structure
is that stages of the process can be expanded to a so-called <em>child
process</em>, which again may expand stages further to new child
processes leading to multiple levels. To illustrate consider the HMDP
shown in the figure below. The process has three levels. At
<code>Level 2</code> we have a set of finite-horizon semi-MDPs (one for
each oval box) which all can be represented using a state-expanded
hypergraph (hyperarcs not shown, only hyperarcs connecting processes are
shown). A semi-MDP at <code>Level 2</code> is uniquely defined by a
given state <span class="math inline">\(s\)</span> and action <span class="math inline">\(a\)</span> of its <em>parent process</em> at
<code>Level 1</code> (illustrated by the arcs with head and tail node at
<code>Level 1</code> and <code>Level 2</code>, respectively). Moreover,
when a child process at <code>Level 2</code> terminates a transition
from a state <span class="math inline">\(s\in \mathcal{S}_{N}\)</span>
of the child process to a state at the next stage of the parent process
occur (illustrated by the (hyper)arcs having head and tail at
<code>Level 2</code> and <code>Level 1</code>, respectively).</p>
<div class="figure" style="text-align: center">
<img src="vignette_files/hmdp_index.png" alt="The state-expanded hypergraph of the first stage of a hierarchical MDP. Level 0 indicate the founder level, and the nodes indicates states at the different levels. A child process (oval box) is represented using its state-expanded hypergraph (hyperarcs not shown) and is uniquely defined by a given state and action of its parent process." style="max-width:100%;"><p class="caption">
The state-expanded hypergraph of the first stage of a hierarchical MDP.
Level 0 indicate the founder level, and the nodes indicates states at
the different levels. A child process (oval box) is represented using
its state-expanded hypergraph (hyperarcs not shown) and is uniquely
defined by a given state and action of its parent process.
</p>
</div>
<p>Since a child process is always defined by a stage, state and action
of the parent process we have that for instance a state at Level 1 can
be identified using an index vector <span class="math inline">\(\nu=(n_{0},s_{0},a_{0},n_{1},s_{1})\)</span> where
<span class="math inline">\(s_1\)</span> is the state id at the given
stage <span class="math inline">\(n_1\)</span> in the process defined by
the action <span class="math inline">\(a_0\)</span> in state <span class="math inline">\(s_0\)</span> at stage <span class="math inline">\(n_0\)</span>. Note all values are ids starting
from zero, e.g. if <span class="math inline">\(s_1=0\)</span> it is the
first state at the corresponding stage and if <span class="math inline">\(a_0=2\)</span> it is the third action at the
corresponding state. In general a state <span class="math inline">\(s\)</span> and action <span class="math inline">\(a\)</span> at level <span class="math inline">\(l\)</span> can be uniquely identified using <span class="math display">\[
\begin{aligned}
\nu_{s}&amp;=(n_{0},s_{0},a_{0},n_{1},s_{1},\ldots,n_{l},s_{l}) \\
\nu_{a}&amp;=(n_{0},s_{0},a_{0},n_{1},s_{1},\ldots,n_{l},s_{l},a_{l}).
\end{aligned}
\]</span> The index vectors for state <span class="math inline">\(v_0\)</span>, <span class="math inline">\(v_1\)</span> and <span class="math inline">\(v_2\)</span> are illustrated in the figure. As
under a semi-MDP another way to identify a state in the state-expanded
hypergraph is using an unique id.</p>
</div>
<div class="section level2">
<h2 id="example">Example<a class="anchor" aria-label="anchor" href="#example"></a>
</h2>
<p>Let us try to solve a small problem from livestock farming, namely
the cow replacement problem where we want to represent the age of the
cow, i.e. the lactation number of the cow. During a lactation a cow may
have a high, average or low yield. We assume that a cow is always
replaced after 4 lactations.</p>
<p>In addition to lactation and milk yield we also want to take the
genetic merit into account which is either bad, average or good. When a
cow is replaced we assume that the probability of a bad, average or good
heifer is equal.</p>
<p>We formulate the problem as a HMDP with 2 levels. At level 0 the
states are the genetic merit and the length of a stage is a life of a
cow. At level 1 a stage describe a lactation and states describe the
yield. Decisions at level 1 are <code>keep</code> or
<code>replace</code>.</p>
<p>Note the MDP runs over an infinite time-horizon at the founder level
where each state (genetic merit) define a semi-MDP at level 1 with 4
lactations.</p>
<p>Let us try to load the model and get some info:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">prefix</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"models"</span>, package <span class="op">=</span> <span class="st">"MDP2"</span><span class="op">)</span>, <span class="st">"/cow_"</span><span class="op">)</span></span>
<span><span class="va">mdp</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/loadMDP.html">loadMDP</a></span><span class="op">(</span><span class="va">prefix</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt; Read binary files (0.000275598 sec.)</span></span>
<span><span class="co">#&gt; Build the HMDP (0.000278498 sec.)</span></span></code></pre>
<pre><code><span><span class="co">#&gt; Checking MDP and found no errors (2.9e-06 sec.)</span></span></code></pre>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mdp</span> </span></code></pre></div>
<pre><code><span><span class="co">#&gt; $binNames</span></span>
<span><span class="co">#&gt; [1] "/home/runner/work/_temp/Library/MDP2/models/cow_stateIdx.bin"         </span></span>
<span><span class="co">#&gt; [2] "/home/runner/work/_temp/Library/MDP2/models/cow_stateIdxLbl.bin"      </span></span>
<span><span class="co">#&gt; [3] "/home/runner/work/_temp/Library/MDP2/models/cow_actionIdx.bin"        </span></span>
<span><span class="co">#&gt; [4] "/home/runner/work/_temp/Library/MDP2/models/cow_actionIdxLbl.bin"     </span></span>
<span><span class="co">#&gt; [5] "/home/runner/work/_temp/Library/MDP2/models/cow_actionWeight.bin"     </span></span>
<span><span class="co">#&gt; [6] "/home/runner/work/_temp/Library/MDP2/models/cow_actionWeightLbl.bin"  </span></span>
<span><span class="co">#&gt; [7] "/home/runner/work/_temp/Library/MDP2/models/cow_transProb.bin"        </span></span>
<span><span class="co">#&gt; [8] "/home/runner/work/_temp/Library/MDP2/models/cow_externalProcesses.bin"</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $timeHorizon</span></span>
<span><span class="co">#&gt; [1] Inf</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $states</span></span>
<span><span class="co">#&gt; [1] 42</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $founderStatesLast</span></span>
<span><span class="co">#&gt; [1] 3</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $actions</span></span>
<span><span class="co">#&gt; [1] 69</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $levels</span></span>
<span><span class="co">#&gt; [1] 2</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $weightNames</span></span>
<span><span class="co">#&gt; [1] "Duration"   "Net reward" "Yield"     </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $ptr</span></span>
<span><span class="co">#&gt; C++ object &lt;0x555bf3e0f250&gt; of class 'HMDP' &lt;0x555bef272790&gt;</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; attr(,"class")</span></span>
<span><span class="co">#&gt; [1] "HMDP" "list"</span></span></code></pre>
<p>The state-expanded hypergraph representing the HMDP with infinite
time-horizon can be plotted using</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">hgf</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/getHypergraph.html">getHypergraph</a></span><span class="op">(</span><span class="va">mdp</span><span class="op">)</span></span>
<span><span class="co">## Rename labels</span></span>
<span><span class="va">dat</span> <span class="op">&lt;-</span> <span class="va">hgf</span><span class="op">$</span><span class="va">nodes</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>   <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>label <span class="op">=</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html" class="external-link">case_when</a></span><span class="op">(</span></span>
<span>      <span class="va">label</span> <span class="op">==</span> <span class="st">"Low yield"</span> <span class="op">~</span> <span class="st">"L"</span>,</span>
<span>      <span class="va">label</span> <span class="op">==</span> <span class="st">"Avg yield"</span> <span class="op">~</span> <span class="st">"A"</span>,</span>
<span>      <span class="va">label</span> <span class="op">==</span> <span class="st">"High yield"</span> <span class="op">~</span> <span class="st">"H"</span>,</span>
<span>      <span class="va">label</span> <span class="op">==</span> <span class="st">"Dummy"</span> <span class="op">~</span> <span class="st">"D"</span>,</span>
<span>      <span class="va">label</span> <span class="op">==</span> <span class="st">"Bad genetic level"</span> <span class="op">~</span> <span class="st">"Bad"</span>,</span>
<span>      <span class="va">label</span> <span class="op">==</span> <span class="st">"Avg genetic level"</span> <span class="op">~</span> <span class="st">"Avg"</span>,</span>
<span>      <span class="va">label</span> <span class="op">==</span> <span class="st">"Good genetic level"</span> <span class="op">~</span> <span class="st">"Good"</span>,</span>
<span>      <span class="cn">TRUE</span> <span class="op">~</span> <span class="st">"Error"</span></span>
<span>   <span class="op">)</span><span class="op">)</span></span>
<span><span class="co">## Set grid id</span></span>
<span><span class="va">dat</span><span class="op">$</span><span class="va">gId</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">]</span><span class="op">&lt;-</span><span class="fl">85</span><span class="op">:</span><span class="fl">87</span></span>
<span><span class="va">dat</span><span class="op">$</span><span class="va">gId</span><span class="op">[</span><span class="fl">43</span><span class="op">:</span><span class="fl">45</span><span class="op">]</span><span class="op">&lt;-</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span></span>
<span><span class="va">getGId</span><span class="op">&lt;-</span><span class="kw">function</span><span class="op">(</span><span class="va">process</span>,<span class="va">stage</span>,<span class="va">state</span><span class="op">)</span> <span class="op">{</span></span>
<span>   <span class="kw">if</span> <span class="op">(</span><span class="va">process</span><span class="op">==</span><span class="fl">0</span><span class="op">)</span> <span class="va">start</span><span class="op">=</span><span class="fl">18</span></span>
<span>   <span class="kw">if</span> <span class="op">(</span><span class="va">process</span><span class="op">==</span><span class="fl">1</span><span class="op">)</span> <span class="va">start</span><span class="op">=</span><span class="fl">22</span></span>
<span>   <span class="kw">if</span> <span class="op">(</span><span class="va">process</span><span class="op">==</span><span class="fl">2</span><span class="op">)</span> <span class="va">start</span><span class="op">=</span><span class="fl">26</span></span>
<span>   <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">start</span> <span class="op">+</span> <span class="fl">14</span> <span class="op">*</span> <span class="va">stage</span> <span class="op">+</span> <span class="va">state</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="va">idx</span><span class="op">&lt;-</span><span class="fl">43</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">process</span> <span class="kw">in</span> <span class="fl">0</span><span class="op">:</span><span class="fl">2</span><span class="op">)</span></span>
<span>   <span class="kw">for</span> <span class="op">(</span><span class="va">stage</span> <span class="kw">in</span> <span class="fl">0</span><span class="op">:</span><span class="fl">4</span><span class="op">)</span></span>
<span>      <span class="kw">for</span> <span class="op">(</span><span class="va">state</span> <span class="kw">in</span> <span class="fl">0</span><span class="op">:</span><span class="fl">2</span><span class="op">)</span> <span class="op">{</span></span>
<span>         <span class="kw">if</span> <span class="op">(</span><span class="va">stage</span><span class="op">==</span><span class="fl">0</span> <span class="op">&amp;</span> <span class="va">state</span><span class="op">&gt;</span><span class="fl">0</span><span class="op">)</span> <span class="kw">break</span></span>
<span>         <span class="va">idx</span><span class="op">&lt;-</span><span class="va">idx</span><span class="op">-</span><span class="fl">1</span></span>
<span>         <span class="co">#cat(idx,process,stage,state,getGId(process,stage,state),"\n")</span></span>
<span>         <span class="va">dat</span><span class="op">$</span><span class="va">gId</span><span class="op">[</span><span class="va">idx</span><span class="op">]</span><span class="op">&lt;-</span><span class="fu">getGId</span><span class="op">(</span><span class="va">process</span>,<span class="va">stage</span>,<span class="va">state</span><span class="op">)</span></span>
<span>      <span class="op">}</span></span>
<span><span class="va">hgf</span><span class="op">$</span><span class="va">nodes</span> <span class="op">&lt;-</span> <span class="va">dat</span></span>
<span><span class="co">## Rename labels</span></span>
<span><span class="va">dat</span> <span class="op">&lt;-</span> <span class="va">hgf</span><span class="op">$</span><span class="va">hyperarcs</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>   <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>label <span class="op">=</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html" class="external-link">case_when</a></span><span class="op">(</span></span>
<span>      <span class="va">label</span> <span class="op">==</span> <span class="st">"Replace"</span> <span class="op">~</span> <span class="st">"R"</span>,</span>
<span>      <span class="va">label</span> <span class="op">==</span> <span class="st">"Keep"</span> <span class="op">~</span> <span class="st">"K"</span>,</span>
<span>      <span class="va">label</span> <span class="op">==</span> <span class="st">"Dummy"</span> <span class="op">~</span> <span class="st">"D"</span>,</span>
<span>      <span class="cn">TRUE</span> <span class="op">~</span> <span class="st">"Error"</span></span>
<span>      <span class="op">)</span>,</span>
<span>      col <span class="op">=</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html" class="external-link">case_when</a></span><span class="op">(</span></span>
<span>         <span class="va">label</span> <span class="op">==</span> <span class="st">"R"</span> <span class="op">~</span> <span class="st">"deepskyblue3"</span>,</span>
<span>         <span class="va">label</span> <span class="op">==</span> <span class="st">"K"</span> <span class="op">~</span> <span class="st">"darkorange1"</span>,</span>
<span>         <span class="va">label</span> <span class="op">==</span> <span class="st">"D"</span> <span class="op">~</span> <span class="st">"black"</span>,</span>
<span>         <span class="cn">TRUE</span> <span class="op">~</span> <span class="st">"Error"</span></span>
<span>      <span class="op">)</span>,</span>
<span>      lwd <span class="op">=</span> <span class="fl">0.5</span>,</span>
<span>      label <span class="op">=</span> <span class="st">""</span></span>
<span>   <span class="op">)</span> </span>
<span><span class="va">hgf</span><span class="op">$</span><span class="va">hyperarcs</span> <span class="op">&lt;-</span> <span class="va">dat</span></span>
<span><span class="co">## Make the plot</span></span>
<span><span class="fu"><a href="../reference/plotHypergraph.html">plotHypergraph</a></span><span class="op">(</span><span class="va">hgf</span>, gridDim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">14</span>, <span class="fl">7</span><span class="op">)</span>, cex <span class="op">=</span> <span class="fl">0.8</span>, radx <span class="op">=</span> <span class="fl">0.02</span>, rady <span class="op">=</span> <span class="fl">0.03</span><span class="op">)</span></span></code></pre></div>
<p><img src="infinite-hmdp_files/figure-html/plotHMDP-1.png" width="864" style="max-width:100%;"></p>
<p>Note action <code>keep</code> is drawn with orange color and action
<code>replace</code> with blue color.</p>
<p>We find the optimal policy under the expected discounted reward
criterion using policy iteration with an interest rate of 10%:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">wLbl</span><span class="op">&lt;-</span><span class="st">"Net reward"</span>         <span class="co"># the weight we want to optimize (net reward)</span></span>
<span><span class="va">durLbl</span><span class="op">&lt;-</span><span class="st">"Duration"</span>         <span class="co"># the duration/time label</span></span>
<span><span class="fu"><a href="../reference/runPolicyIteDiscount.html">runPolicyIteDiscount</a></span><span class="op">(</span><span class="va">mdp</span>, <span class="va">wLbl</span>, <span class="va">durLbl</span>, rate <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt; Run policy iteration using quantity 'Net reward' under discounting criterion </span></span>
<span><span class="co">#&gt; with 'Duration' as duration using discount factor 0.904837. </span></span>
<span><span class="co">#&gt; Iteration(s): 1 2 3 4 finished. Cpu time: 2.9e-06 sec.</span></span></code></pre>
<p>The optimal policy is:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">hgf</span><span class="op">$</span><span class="va">hyperarcs</span> <span class="op">&lt;-</span> <span class="fu">right_join</span><span class="op">(</span><span class="va">hgf</span><span class="op">$</span><span class="va">hyperarcs</span>, <span class="fu"><a href="../reference/getPolicy.html">getPolicy</a></span><span class="op">(</span><span class="va">mdp</span><span class="op">)</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"sId"</span>, <span class="st">"aIdx"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/plotHypergraph.html">plotHypergraph</a></span><span class="op">(</span><span class="va">hgf</span>, gridDim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">14</span>, <span class="fl">7</span><span class="op">)</span>, cex <span class="op">=</span> <span class="fl">0.8</span>, radx <span class="op">=</span> <span class="fl">0.02</span>, rady <span class="op">=</span> <span class="fl">0.03</span><span class="op">)</span></span></code></pre></div>
<p><img src="infinite-hmdp_files/figure-html/plotPolicy-1.png" width="864" style="max-width:100%;"></p>
<p>We may also find the policy which maximize the average reward per
lactation:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">wLbl</span><span class="op">&lt;-</span><span class="st">"Net reward"</span>         <span class="co"># the weight we want to optimize (net reward)</span></span>
<span><span class="va">durLbl</span><span class="op">&lt;-</span><span class="st">"Duration"</span>         <span class="co"># the duration/time label</span></span>
<span><span class="fu"><a href="../reference/runPolicyIteAve.html">runPolicyIteAve</a></span><span class="op">(</span><span class="va">mdp</span>, <span class="va">wLbl</span>, <span class="va">durLbl</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt; Run policy iteration under average reward criterion using </span></span>
<span><span class="co">#&gt; reward 'Net reward' over 'Duration'. Iterations (g): </span></span>
<span><span class="co">#&gt; 1 (11000) 2 (11517.5) 3 (11543.8) 4 (11543.8) finished. Cpu time: 2.9e-06 sec.</span></span></code></pre>
<pre><code><span><span class="co">#&gt; [1] 11543.83</span></span></code></pre>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/getPolicy.html">getPolicy</a></span><span class="op">(</span><span class="va">mdp</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 42 × 6</span></span></span>
<span><span class="co">#&gt;      sId stateStr  stateLabel  aIdx actionLabel  weight</span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>      <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>         <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span>     3 0,2,0,4,0 Low yield      0 Replace     -<span style="color: #BB0000; text-decoration: underline;">7</span><span style="color: #BB0000;">369.</span> </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span>     4 0,2,0,4,1 Avg yield      0 Replace     -<span style="color: #BB0000; text-decoration: underline;">5</span><span style="color: #BB0000;">369.</span> </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span>     5 0,2,0,4,2 High yield     0 Replace     -<span style="color: #BB0000; text-decoration: underline;">3</span><span style="color: #BB0000;">369.</span> </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span>     6 0,2,0,3,0 Low yield      0 Keep        -<span style="color: #BB0000; text-decoration: underline;">5</span><span style="color: #BB0000;">912.</span> </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span>     7 0,2,0,3,1 Avg yield      0 Keep        -<span style="color: #BB0000; text-decoration: underline;">2</span><span style="color: #BB0000;">912.</span> </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span>     8 0,2,0,3,2 High yield     0 Keep           87.7</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span>     9 0,2,0,2,0 Low yield      0 Keep        -<span style="color: #BB0000; text-decoration: underline;">3</span><span style="color: #BB0000;">956.</span> </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span>    10 0,2,0,2,1 Avg yield      0 Keep         -<span style="color: #BB0000;">456.</span> </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span>    11 0,2,0,2,2 High yield     0 Keep         <span style="text-decoration: underline;">3</span>044. </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span>    12 0,2,0,1,0 Low yield      0 Keep        -<span style="color: #BB0000; text-decoration: underline;">3</span><span style="color: #BB0000;">750</span>  </span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># … with 32 more rows</span></span></span></code></pre>
<p>Since other weights are defined for each action we can calculate the
average reward per litre milk under the optimal policy:</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/runCalcWeights.html">runCalcWeights</a></span><span class="op">(</span><span class="va">mdp</span>, w<span class="op">=</span><span class="va">wLbl</span>, criterion<span class="op">=</span><span class="st">"average"</span>, dur <span class="op">=</span> <span class="st">"Yield"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt; [1] 1.932615</span></span></code></pre>
<p>or the average yield per lactation:</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/runCalcWeights.html">runCalcWeights</a></span><span class="op">(</span><span class="va">mdp</span>, w<span class="op">=</span><span class="st">"Yield"</span>, criterion<span class="op">=</span><span class="st">"average"</span>, dur <span class="op">=</span> <span class="va">durLbl</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt; [1] 5973.166</span></span></code></pre>
</div>
<div class="section level2 unnumbered">
<h2 class="unnumbered" id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
<div id="refs" class="references csl-bib-body hanging-indent">
<div id="ref-Kristensen00" class="csl-entry">
Kristensen, A. R., and E. Jørgensen. 2000. <span>“Multi-Level Hierarchic
<span>M</span>arkov Processes as a Framework for Herd Management
Support.”</span> <em>Annals of Operations Research</em> 94: 69–89. <a href="https://doi.org/10.1023/A:1018921201113" class="external-link">https://doi.org/10.1023/A:1018921201113</a>.
</div>
<div id="ref-Relund06" class="csl-entry">
Nielsen, L. R., and A. R. Kristensen. 2006. <span>“Finding the
<span><span class="math inline">\(K\)</span></span> Best Policies in a
Finite-Horizon <span>M</span>arkov Decision Process.”</span>
<em>European Journal of Operational Research</em> 175 (2): 1164–79. <a href="https://doi.org/10.1016/j.ejor.2005.06.011" class="external-link">https://doi.org/10.1016/j.ejor.2005.06.011</a>.
</div>
<div id="ref-Puterman94" class="csl-entry">
Puterman, M. L. 1994. <em>Markov Decision Processes</em>. Wiley Series
in Probability and Mathematical Statistics. Wiley-Interscience.
</div>
<div id="ref-Tijms03" class="csl-entry">
Tijms, Henk. C. 2003. <em>A First Course in Stochastic Models</em>. John
Wiley &amp; Sons Ltd.
</div>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Lars Relund Nielsen.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
