<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="MDP2">
<title>Building an MDP model • MDP2</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.2.2/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.2.2/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Building an MDP model">
<meta property="og:description" content="MDP2">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">MDP2</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">2.1.2</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/building.html">Building an MDP model</a>
    <a class="dropdown-item" href="../articles/finite-mdp.html">Solving a finite-horizon semi-MDP</a>
    <a class="dropdown-item" href="../articles/infinite-hmdp.html">An infinite-horizon HMDP</a>
    <a class="dropdown-item" href="../articles/infinite-mdp.html">Solving an infinite-horizon semi-MDP</a>
    <a class="dropdown-item" href="../articles/mdp2.html">The MDP2 package</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/relund/mdp/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Building an MDP model</h1>
                        <h4 data-toc-skip class="author">Lars Relund <a href="mailto:lars@relund.dk" class="email">lars@relund.dk</a>
</h4>
            
            <h4 data-toc-skip class="date">2023-01-27</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/relund/mdp/blob/HEAD/vignettes/building.Rmd" class="external-link"><code>vignettes/building.Rmd</code></a></small>
      <div class="d-none name"><code>building.Rmd</code></div>
    </div>

    
    
<style> 
p {text-align: justify;} 
//.sourceCode {background-color: white;}
pre {
  // border-style: solid;
  // border-width: 1px;
  // border-color: grey;
  //background-color: grey !important;
}
img {
   //width: 100%;
   border: 0;
}
</style>
<!-- scale math down --><script type="text/x-mathjax-config"> 
    MathJax.Hub.Config({ 
        "HTML-CSS": { scale: 80 }
        });
</script><p>Building and solving an MDP is done in two steps. First, the MDP is
built and saved in a set of binary files. Next, you load the MDP into
memory from the binary files and apply various algorithms to the
model.</p>
<p>In this vignette we focus on the first step, i.e. building and saving
the model to a set of binary files.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://relund.github.io/mdp/" class="external-link">MDP2</a></span><span class="op">)</span></span></code></pre></div>
<div class="section level2">
<h2 id="an-infinite-semi-mdp">An infinite semi-MDP<a class="anchor" aria-label="anchor" href="#an-infinite-semi-mdp"></a>
</h2>
<p>An <em>infinite-horizon semi-MDP</em> considers a sequential decision
problem over an infinite number of <em>stages</em>. Let <span class="math inline">\(I\)</span> denote the finite set of system states
at stage <span class="math inline">\(n\)</span>. Note we assume that the
semi-MDP is <em>homogeneous</em>, i.e the state space is independent of
stage number. When <em>state</em> <span class="math inline">\(i \in
I\)</span> is observed, an <em>action</em> <span class="math inline">\(a\)</span> from the finite set of allowable
actions <span class="math inline">\(A(i)\)</span> must be chosen which
generates <em>reward</em> <span class="math inline">\(r(i,a)\)</span>.
Moreover, let <span class="math inline">\(\tau(i,a)\)</span> denote the
<em>stage length</em> of action <span class="math inline">\(a\)</span>,
i.e. the expected time until the next decision epoch (stage <span class="math inline">\(n+1\)</span>) given action <span class="math inline">\(a\)</span> and state <span class="math inline">\(i\)</span>. Finally, let <span class="math inline">\(p_{ij}(a)\)</span> denote the <em>transition
probability</em> of obtaining state <span class="math inline">\(j\in
I\)</span> at stage <span class="math inline">\(n+1\)</span> given that
action <span class="math inline">\(a\)</span> is chosen in state <span class="math inline">\(i\)</span> at stage <span class="math inline">\(n\)</span>. A policy is a decision rule/function
that assigns to each state in the process an action. Note if the stage
length is the same for all states and actions the we have a regular
<em>infinite-horizon MDP</em>.</p>
<p>Let us consider Example 6.1.1 in <span class="citation">Tijms
(2003)</span>. At the beginning of each day a piece of equipment is
inspected to reveal its actual working condition. The equipment will be
found in one of the working conditions <span class="math inline">\(i =
1,\ldots, N\)</span> where the working condition <span class="math inline">\(i\)</span> is better than the working condition
<span class="math inline">\(i+1\)</span>. The equipment deteriorates in
time. If the present working condition is <span class="math inline">\(i\)</span> and no repair is done, then at the
beginning of the next day the equipment has working condition <span class="math inline">\(j\)</span> with probability <span class="math inline">\(q_{ij}\)</span>. It is assumed that <span class="math inline">\(q_{ij}=0\)</span> for <span class="math inline">\(j&lt;i\)</span> and <span class="math inline">\(\sum_{j\geq i}q_{ij}=1\)</span>. The working
condition <span class="math inline">\(i=N\)</span> represents a
malfunction that requires an enforced repair taking two days. For the
intermediate states <span class="math inline">\(i\)</span> with <span class="math inline">\(1&lt;i&lt;N\)</span> there is a choice between
preventively repairing the equipment and letting the equipment operate
for the present day. A preventive repair takes only one day. A repaired
system has the working condition <span class="math inline">\(i=1\)</span>. The cost of an enforced repair upon
failure is <span class="math inline">\(C_{f}\)</span> and the cost of a
preemptive repair in working condition <span class="math inline">\(i\)</span> is <span class="math inline">\(C_{p}(i)\)</span>. We wish to determine a
maintenance rule which minimizes the long-run average repair cost per
day.</p>
<p>To formulate this problem as an infinite horizon semi-MDP the set of
possible states of the system is chosen as <span class="math display">\[
I=\{1,2,\ldots,N\}.
\]</span> State <span class="math inline">\(i\)</span> corresponds to
the situation in which an inspection reveals working condition <span class="math inline">\(i\)</span>. Define actions <span class="math display">\[
a=\left\{\begin{array}{ll}
nr &amp; \text{if no repair.}\\
pr &amp; \text{if preventive repair.}\\
fr &amp; \text{if forced repair.}\\
\end{array}\right.
\]</span> The set of possible actions in state <span class="math inline">\(i\)</span> is chosen as <span class="math inline">\(A(1)=\{nr\},\ A(i)=\{nr,pr\}\)</span> for <span class="math inline">\(1&lt;i&lt;N, A(N)=\{fr\}\)</span>. The one-step
transition probabilities <span class="math inline">\(p_{ij}(a)\)</span>
are given by <span class="math inline">\(p_{ij}(0) = q_{ij}\)</span> for
<span class="math inline">\(1\leq i&lt;N\)</span>, <span class="math inline">\(p_{i1}(1) = 1\)</span> for <span class="math inline">\(1&lt;i&lt;N\)</span>, <span class="math inline">\(p_{N1}(2)=1\)</span> and zero otherwise. The
one-step costs <span class="math inline">\(c_{i}(a)\)</span> are given
by <span class="math inline">\(c_{i}(0)=0,\ c_{i}(1)=C_{p}(i)\)</span>
and <span class="math inline">\(c_{N}(2)=C_{f}\)</span>. The stage
length until next decision epoch are <span class="math inline">\(\tau(i,a) = 1, 0\leq i &lt; N\)</span> and <span class="math inline">\(\tau(N,a) = 2\)</span>.</p>
<p>Assume that the number of possible working conditions equals <span class="math inline">\(N=5\)</span>, i.e. the number of states are:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">N</span> <span class="op">&lt;-</span> <span class="fl">5</span></span>
<span><span class="va">states</span> <span class="op">&lt;-</span> <span class="fu">tibble</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span></span>
<span>      idx <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="va">N</span> <span class="op">-</span> <span class="fl">1</span>,</span>
<span>      label <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"i = "</span>, <span class="fl">1</span><span class="op">:</span><span class="va">N</span><span class="op">)</span></span>
<span>   <span class="op">)</span></span>
<span><span class="va">states</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 5 × 2</span></span></span>
<span><span class="co">#&gt;     idx label</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span>     0 i = 1</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span>     1 i = 2</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span>     2 i = 3</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span>     3 i = 4</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">5</span>     4 i = 5</span></span></code></pre>
<p>Note each state are given an index and are always numbered from zero.
The repair costs (negative numbers since the MDP optimize based on
rewards) are:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">Cf</span> <span class="op">&lt;-</span> <span class="op">-</span><span class="fl">10</span></span>
<span><span class="va">Cp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="op">-</span><span class="fl">7</span>, <span class="op">-</span><span class="fl">7</span>, <span class="op">-</span><span class="fl">5</span><span class="op">)</span></span></code></pre></div>
<p>The deterioration probabilities <span class="math inline">\(q_{ij}\)</span> are</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">Q</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>   <span class="fl">0.90</span>, <span class="fl">0.10</span>, <span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">0</span>,</span>
<span>   <span class="fl">0</span>, <span class="fl">0.80</span>, <span class="fl">0.10</span>, <span class="fl">0.05</span>, <span class="fl">0.05</span>,</span>
<span>   <span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">0.70</span>, <span class="fl">0.10</span>, <span class="fl">0.20</span>,</span>
<span>   <span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">0.50</span>, <span class="fl">0.50</span><span class="op">)</span>, </span>
<span>   nrow<span class="op">=</span><span class="fl">4</span>, byrow<span class="op">=</span><span class="cn">T</span><span class="op">)</span> </span></code></pre></div>
<p>To build the model we need transition probabilities and the state
index for the corresponding transitions. We may define function:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' Transition probabilities</span></span>
<span><span class="co">#' @param i State (1 &lt;= i &lt;= N). </span></span>
<span><span class="co">#' @param a Action (`nr`, `pr` or `fr`).</span></span>
<span><span class="co">#' @return A list with non-zero transition probabilities and state index of the transitions.</span></span>
<span><span class="va">transPr</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">i</span>, <span class="va">a</span><span class="op">)</span> <span class="op">{</span></span>
<span>   <span class="va">pr</span> <span class="op">&lt;-</span> <span class="cn">NULL</span></span>
<span>   <span class="va">idx</span> <span class="op">&lt;-</span> <span class="cn">NULL</span></span>
<span>   <span class="kw">if</span> <span class="op">(</span><span class="va">a</span> <span class="op">==</span> <span class="st">"nr"</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">pr</span> <span class="op">&lt;-</span> <span class="va">Q</span><span class="op">[</span><span class="va">i</span>, <span class="op">]</span></span>
<span>      <span class="va">idx</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">pr</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span>  <span class="co"># only consider trans pr &gt; 0</span></span>
<span>      <span class="va">pr</span> <span class="op">&lt;-</span> <span class="va">pr</span><span class="op">[</span><span class="va">idx</span><span class="op">]</span></span>
<span>      <span class="va">idx</span> <span class="op">&lt;-</span> <span class="va">idx</span> <span class="op">-</span> <span class="fl">1</span>  <span class="co"># since state index is state-1</span></span>
<span>   <span class="op">}</span></span>
<span>   <span class="kw">if</span> <span class="op">(</span><span class="va">a</span> <span class="op">==</span> <span class="st">"pr"</span> <span class="op">|</span> <span class="va">a</span> <span class="op">==</span> <span class="st">"fr"</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">pr</span> <span class="op">&lt;-</span> <span class="fl">1</span></span>
<span>      <span class="va">idx</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span>   <span class="op">}</span></span>
<span>   <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>pr <span class="op">=</span> <span class="va">pr</span>, idx <span class="op">=</span> <span class="va">idx</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>The transition probabilities for state 1 and the “no repair” action
is now:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">transPr</span><span class="op">(</span><span class="fl">1</span>, <span class="st">"nr"</span><span class="op">)</span> </span></code></pre></div>
<pre><code><span><span class="co">#&gt; $pr</span></span>
<span><span class="co">#&gt; [1] 0.9 0.1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $idx</span></span>
<span><span class="co">#&gt; [1] 0 1</span></span></code></pre>
<p>That is, 90% for a transition to the state with index 0 (<span class="math inline">\(i = 0\)</span>) and 10% for a transition to the
state with index 1 (<span class="math inline">\(i = 2\)</span>). Note we
always assume that the states at the next stage is numbered using an
index starting from zero!</p>
<p>The state-expanded hypergraph representing the semi-MDP with infinite
time-horizon is shown in Figure 1. Here the first stage is visualized.
Each node corresponds to a specific state in the MDP. A directed
hyperarc is defined for each possible action. For instance, the
state/node corresponding to working condition <span class="math inline">\(i=2\)</span> and the two hyperarcs with head in
this node corresponds to the two possible actions preventive and no
repair. Note the tails of a hyperarc represent a possible transition
(<span class="math inline">\(p_{ij}(a)&gt;0\)</span>).</p>
<div class="figure" style="text-align: center">
<img src="building_files/figure-html/semi-mdp-1.png" alt="Figure 1: The state-expanded hypergraph for the semi-MDP." width="864" style="max-width:100%;"><p class="caption">
Figure 1: The state-expanded hypergraph for the semi-MDP.
</p>
</div>
<p>To build the semi-MDP, we use the <code>binaryMDPWriter</code> where
the model can be built using either matrices or an hierarchical
structure. We first illustrate how to use the hierarchical
structure.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">labels</span> <span class="op">&lt;-</span> <span class="va">states</span><span class="op">$</span><span class="va">label</span></span>
<span><span class="va">w</span><span class="op">&lt;-</span><span class="fu"><a href="../reference/binaryMDPWriter.html">binaryMDPWriter</a></span><span class="op">(</span><span class="st">"hct611-1_"</span><span class="op">)</span> <span class="co"># use prefix hct611-1_ to the files</span></span>
<span><span class="va">w</span><span class="op">$</span><span class="fu">setWeights</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Duration"</span>, <span class="st">"Net reward"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">w</span><span class="op">$</span><span class="fu">process</span><span class="op">(</span><span class="op">)</span> <span class="co"># founder process</span></span>
<span>   <span class="va">w</span><span class="op">$</span><span class="fu">stage</span><span class="op">(</span><span class="op">)</span> <span class="co"># a stage with states</span></span>
<span>      <span class="va">w</span><span class="op">$</span><span class="fu">state</span><span class="op">(</span>label <span class="op">=</span> <span class="va">labels</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span> <span class="co"># state 1</span></span>
<span>         <span class="va">lst</span> <span class="op">&lt;-</span> <span class="fu">transPr</span><span class="op">(</span><span class="fl">1</span>, <span class="st">"nr"</span><span class="op">)</span></span>
<span>         <span class="va">w</span><span class="op">$</span><span class="fu">action</span><span class="op">(</span>label <span class="op">=</span> <span class="st">"nr"</span>, weights <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">0</span><span class="op">)</span>, pr <span class="op">=</span> <span class="va">lst</span><span class="op">$</span><span class="va">pr</span>, id <span class="op">=</span> <span class="va">lst</span><span class="op">$</span><span class="va">id</span>, end <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>      <span class="va">w</span><span class="op">$</span><span class="fu">endState</span><span class="op">(</span><span class="op">)</span> <span class="co"># end state 1</span></span>
<span>      <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">2</span><span class="op">:</span><span class="op">(</span><span class="va">N</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span> <span class="co"># states 2 to N-1</span></span>
<span>         <span class="va">w</span><span class="op">$</span><span class="fu">state</span><span class="op">(</span>label <span class="op">=</span> <span class="va">labels</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span></span>
<span>            <span class="va">lst</span> <span class="op">&lt;-</span> <span class="fu">transPr</span><span class="op">(</span><span class="va">i</span>, <span class="st">"nr"</span><span class="op">)</span></span>
<span>            <span class="va">w</span><span class="op">$</span><span class="fu">action</span><span class="op">(</span>label <span class="op">=</span> <span class="st">"nr"</span>, weights <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">0</span><span class="op">)</span>, pr <span class="op">=</span> <span class="va">lst</span><span class="op">$</span><span class="va">pr</span>, id <span class="op">=</span> <span class="va">lst</span><span class="op">$</span><span class="va">id</span>, end <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>            <span class="va">lst</span><span class="op">&lt;-</span><span class="fu">transPr</span><span class="op">(</span><span class="va">i</span>, <span class="st">"pr"</span><span class="op">)</span></span>
<span>            <span class="va">w</span><span class="op">$</span><span class="fu">action</span><span class="op">(</span>label <span class="op">=</span> <span class="st">"pr"</span>, weights <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">Cp</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span>, pr <span class="op">=</span> <span class="va">lst</span><span class="op">$</span><span class="va">pr</span>, id <span class="op">=</span> <span class="va">lst</span><span class="op">$</span><span class="va">id</span>, end <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>         <span class="va">w</span><span class="op">$</span><span class="fu">endState</span><span class="op">(</span><span class="op">)</span></span>
<span>      <span class="op">}</span></span>
<span>      <span class="va">w</span><span class="op">$</span><span class="fu">state</span><span class="op">(</span>label <span class="op">=</span> <span class="va">labels</span><span class="op">[</span><span class="va">N</span><span class="op">]</span><span class="op">)</span></span>
<span>         <span class="va">lst</span><span class="op">&lt;-</span><span class="fu">transPr</span><span class="op">(</span><span class="va">N</span>, <span class="st">"fr"</span><span class="op">)</span></span>
<span>         <span class="va">w</span><span class="op">$</span><span class="fu">action</span><span class="op">(</span>label <span class="op">=</span> <span class="st">"fr"</span>, weights <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>, <span class="va">Cf</span><span class="op">)</span>, pr <span class="op">=</span> <span class="va">lst</span><span class="op">$</span><span class="va">pr</span>, id <span class="op">=</span> <span class="va">lst</span><span class="op">$</span><span class="va">id</span>, end <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>      <span class="va">w</span><span class="op">$</span><span class="fu">endState</span><span class="op">(</span><span class="op">)</span></span>
<span>   <span class="va">w</span><span class="op">$</span><span class="fu">endStage</span><span class="op">(</span><span class="op">)</span> <span class="co"># end stage</span></span>
<span><span class="va">w</span><span class="op">$</span><span class="fu">endProcess</span><span class="op">(</span><span class="op">)</span> <span class="co"># end process</span></span>
<span><span class="va">w</span><span class="op">$</span><span class="fu">closeWriter</span><span class="op">(</span><span class="op">)</span> <span class="co"># close the binary files</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;   Statistics:</span></span>
<span><span class="co">#&gt;     states : 5 </span></span>
<span><span class="co">#&gt;     actions: 8 </span></span>
<span><span class="co">#&gt;     weights: 2 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;   Closing binary MDP writer.</span></span></code></pre>
<p>Observe that</p>
<ul>
<li>We build the model with two weights applied to each action
“Duration” and “Net reward”. That is, when we specify an action, we must
add two weights. “Duration” equals 1 day except in state <span class="math inline">\(i=N\)</span> where a forced repair takes 2
days.</li>
<li>The process is built using first a <code>process</code> which
contains a <code>stage</code> (we only specify one stage, since we have
a homogeneous semi-MDP over an infinite horizon) which contains
<code>state</code>s which contains <code>action</code>s.</li>
<li>Transitions of an <code>action</code> are specified using the
<code>pr</code> and <code>id</code> parameter.</li>
<li>The <code>end = TRUE</code> argument in an action specify that the
action is a normal action that not define a sub-process.</li>
<li>The model is saved in a set of binary files with prefix
<code>hct611-1_</code>.</li>
</ul>
<p>Building the model may be error prone and you may use
<code><a href="../reference/getBinInfoStates.html">getBinInfoStates()</a></code> and <code><a href="../reference/getBinInfoActions.html">getBinInfoActions()</a></code> to
retrieve info about the content of the binary files:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/getBinInfoStates.html">getBinInfoStates</a></span><span class="op">(</span><span class="st">"hct611-1_"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 5 × 3</span></span></span>
<span><span class="co">#&gt;     sId stageStr label</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span>     0 0,0      i = 1</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span>     1 0,1      i = 2</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span>     2 0,2      i = 3</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span>     3 0,3      i = 4</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">5</span>     4 0,4      i = 5</span></span></code></pre>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/getBinInfoActions.html">getBinInfoActions</a></span><span class="op">(</span><span class="st">"hct611-1_"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 8 × 8</span></span></span>
<span><span class="co">#&gt;     aId   sId scope   index   pr                Duration `Net reward` label</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>                <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>        <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span>     0     0 1,1     0,1     0.9,0.1                  1            0 nr   </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span>     1     1 1,1,1,1 1,2,3,4 0.8,0.1,0.05,0.05        1            0 nr   </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span>     2     1 1       0       1                        1           -<span style="color: #BB0000;">7</span> pr   </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span>     3     2 1,1,1   2,3,4   0.7,0.1,0.2              1            0 nr   </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">5</span>     4     2 1       0       1                        1           -<span style="color: #BB0000;">7</span> pr   </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">6</span>     5     3 1,1     3,4     0.5,0.5                  1            0 nr   </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">7</span>     6     3 1       0       1                        1           -<span style="color: #BB0000;">5</span> pr   </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">8</span>     7     4 1       0       1                        2          -<span style="color: #BB0000;">10</span> fr</span></span></code></pre>
<p>The model can be loaded using the <code><a href="../reference/loadMDP.html">loadMDP()</a></code>
function.</p>
<p>The model can also be built by specifying a set of matrices. Note
this way of specifying <strong>only work</strong> for infinite-horizon
semi-MDPs (and not finite-horizon or hierarchical models). Specify a
list of probability matrices (one for each action) where each row/state
contains the transition probabilities (all zero if the action is not
used in a state), a matrix with rewards and a matrix with stage lengths
(row = state, column = action).</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## Define probability matrices</span></span>
<span><span class="va">P</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co"># a = nr (no repair)</span></span>
<span><span class="va">P</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="va">Q</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># a = pr (preventive repair)</span></span>
<span><span class="va">Z</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fl">0</span>, nrow <span class="op">=</span> <span class="va">N</span>, ncol <span class="op">=</span> <span class="va">N</span><span class="op">)</span></span>
<span><span class="va">Z</span><span class="op">[</span><span class="fl">2</span>, <span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">Z</span><span class="op">[</span><span class="fl">3</span>, <span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">Z</span><span class="op">[</span><span class="fl">4</span>, <span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">1</span></span>
<span><span class="va">P</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">Z</span></span>
<span></span>
<span><span class="co"># a = fr (forced repair)</span></span>
<span><span class="va">Z</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fl">0</span>, nrow <span class="op">=</span> <span class="va">N</span>, ncol <span class="op">=</span> <span class="va">N</span><span class="op">)</span></span>
<span><span class="va">Z</span><span class="op">[</span><span class="fl">5</span>, <span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">1</span></span>
<span><span class="va">P</span><span class="op">[[</span><span class="fl">3</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">Z</span></span>
<span></span>
<span><span class="co">## Rewards, a 5x3 matrix with one column for each action</span></span>
<span><span class="va">R</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fl">0</span>, nrow <span class="op">=</span> <span class="va">N</span>, ncol <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span>
<span><span class="va">R</span><span class="op">[</span><span class="fl">2</span><span class="op">:</span><span class="fl">4</span>, <span class="fl">2</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">Cp</span><span class="op">[</span><span class="fl">2</span><span class="op">:</span><span class="fl">4</span><span class="op">]</span></span>
<span><span class="va">R</span><span class="op">[</span><span class="fl">5</span>, <span class="fl">3</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">Cf</span></span>
<span></span>
<span><span class="co">## State lengths, a 5x3 matrix with one column for each action</span></span>
<span><span class="va">D</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fl">1</span>, nrow <span class="op">=</span> <span class="va">N</span>, ncol <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span>
<span><span class="va">D</span><span class="op">[</span><span class="fl">5</span>, <span class="fl">3</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">2</span></span>
<span></span>
<span><span class="co">## Build model using the matrix specification</span></span>
<span><span class="va">w</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/binaryMDPWriter.html">binaryMDPWriter</a></span><span class="op">(</span><span class="st">"hct611-2_"</span><span class="op">)</span></span>
<span><span class="va">w</span><span class="op">$</span><span class="fu">setWeights</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Duration"</span>, <span class="st">"Net reward"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">w</span><span class="op">$</span><span class="fu">process</span><span class="op">(</span><span class="va">P</span>, <span class="va">R</span>, <span class="va">D</span><span class="op">)</span></span>
<span><span class="va">w</span><span class="op">$</span><span class="fu">closeWriter</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;   Statistics:</span></span>
<span><span class="co">#&gt;     states : 5 </span></span>
<span><span class="co">#&gt;     actions: 8 </span></span>
<span><span class="co">#&gt;     weights: 2 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;   Closing binary MDP writer.</span></span></code></pre>
</div>
<div class="section level2">
<h2 id="a-finite-horizon-semi-mdp">A finite-horizon semi-MDP<a class="anchor" aria-label="anchor" href="#a-finite-horizon-semi-mdp"></a>
</h2>
<p>A <em>finite-horizon semi-MDP</em> considers a sequential decision
problem over <span class="math inline">\(N\)</span> <em>stages</em>. Let
<span class="math inline">\(I_{n}\)</span> denote the finite set of
system states at stage <span class="math inline">\(n\)</span>. When
<em>state</em> <span class="math inline">\(i \in I_{n}\)</span> is
observed, an <em>action</em> <span class="math inline">\(a\)</span> from
the finite set of allowable actions <span class="math inline">\(A_n(i)\)</span> must be chosen, and this decision
generates <em>reward</em> <span class="math inline">\(r_{n}(i,a)\)</span>. Moreover, let <span class="math inline">\(\tau_n(i,a)\)</span> denote the <em>stage
length</em> of action <span class="math inline">\(a\)</span>, i.e. the
expected time until the next decision epoch (stage <span class="math inline">\(n+1\)</span>) given action <span class="math inline">\(a\)</span> and state <span class="math inline">\(i\)</span>. Finally, let <span class="math inline">\(p_{ij}(a,n)\)</span> denote the <em>transition
probability</em> of obtaining state <span class="math inline">\(j\in
I_{n+1}\)</span> at stage <span class="math inline">\(n+1\)</span> given
that action <span class="math inline">\(a\)</span> is chosen in state
<span class="math inline">\(i\)</span> at stage <span class="math inline">\(n\)</span>.</p>
<p>Consider a small machine repair problem used as an example in <span class="citation">Nielsen and Kristensen (2006)</span> where the machine
is always replaced after 4 years. The state of the machine may be: good,
average, and not working. Given the machine’s state we may maintain the
machine. In this case the machine’s state will be good at the next
decision epoch. Otherwise, the machine’s state will not be better at
next decision epoch. When the machine is bought it may be either in
state good or average. Moreover, if the machine is not working it must
be replaced.</p>
<p>The problem of when to replace the machine can be modeled using a
Markov decision process with <span class="math inline">\(N=5\)</span>
decision epochs. We use system states <code>good</code>,
<code>average</code>, <code>not working</code> and dummy state
<code>replaced</code> together with actions buy (<code>buy</code>),
maintain (<code>mt</code>), no maintenance (<code>nmt</code>), and
replace (<code>rep</code>). The set of states at stage zero <span class="math inline">\(S_{0}\)</span> contains a single dummy state
<code>dummy</code> representing the machine before knowing its initial
state. The only possible action is <code>buy</code>.</p>
<p>The cost of buying the machine is 100 with transition probability of
0.7 to state <code>good</code> and 0.3 to state <code>average</code>.
The reward (scrap value) of replacing a machine is 30, 10, and 5 in
state <code>good</code>, <code>average</code> and
<code>not working</code>, respectively. The reward of the machine given
action <code>mt</code> are 55, 40, and 30 in state <code>good</code>,
<code>average</code> and <code>not working</code>, respectively.
Moreover, the system enters state 0 with probability 1 at the next
stage. Finally, the reward, transition states and probabilities given
action <span class="math inline">\(a=\)</span><code>nmt</code> are given
by:</p>
<table class="table">
<thead><tr class="header">
<th align="left"><span class="math inline">\(n:s\)</span></th>
<th align="center">
<span class="math inline">\(1:\)</span>
<code>good</code>
</th>
<th align="center">
<span class="math inline">\(1:\)</span>
<code>average</code>
</th>
<th align="center">
<span class="math inline">\(2:\)</span>
<code>good</code>
</th>
<th align="center">
<span class="math inline">\(2:\)</span>
<code>average</code>
</th>
<th align="center">
<span class="math inline">\(3:\)</span>
<code>good</code>
</th>
<th align="center">
<span class="math inline">\(3:\)</span>
<code>average</code>
</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left"><span class="math inline">\(r_n(i,a)\)</span></td>
<td align="center">70</td>
<td align="center">50</td>
<td align="center">70</td>
<td align="center">50</td>
<td align="center">70</td>
<td align="center">50</td>
</tr>
<tr class="even">
<td align="left"><span class="math inline">\(j\)</span></td>
<td align="center"><span class="math inline">\(\{0,1\}\)</span></td>
<td align="center"><span class="math inline">\(\{1,2\}\)</span></td>
<td align="center"><span class="math inline">\(\{0,1\}\)</span></td>
<td align="center"><span class="math inline">\(\{1,2\}\)</span></td>
<td align="center"><span class="math inline">\(\{0,1\}\)</span></td>
<td align="center"><span class="math inline">\(\{1,2\}\)</span></td>
</tr>
<tr class="odd">
<td align="left"><span class="math inline">\(p_{ij}(a,n)\)</span></td>
<td align="center"><span class="math inline">\(\{0.6,0.4\}\)</span></td>
<td align="center"><span class="math inline">\(\{0.6,0.4\}\)</span></td>
<td align="center"><span class="math inline">\(\{0.5,0.5\}\)</span></td>
<td align="center"><span class="math inline">\(\{0.5,0.5\}\)</span></td>
<td align="center"><span class="math inline">\(\{0.2,0.8\}\)</span></td>
<td align="center"><span class="math inline">\(\{0.2,0.8\}\)</span></td>
</tr>
</tbody>
</table>
<p>We build the MDP (all actions have same length) using the
<code><a href="../reference/binaryMDPWriter.html">binaryMDPWriter()</a></code> function:</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">prefix</span><span class="op">&lt;-</span><span class="st">"machine1_"</span></span>
<span><span class="va">w</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/binaryMDPWriter.html">binaryMDPWriter</a></span><span class="op">(</span><span class="va">prefix</span><span class="op">)</span></span>
<span><span class="va">w</span><span class="op">$</span><span class="fu">setWeights</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Net reward"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">w</span><span class="op">$</span><span class="fu">process</span><span class="op">(</span><span class="op">)</span></span>
<span>    <span class="va">w</span><span class="op">$</span><span class="fu">stage</span><span class="op">(</span><span class="op">)</span>   <span class="co"># stage n=0</span></span>
<span>        <span class="va">w</span><span class="op">$</span><span class="fu">state</span><span class="op">(</span>label<span class="op">=</span><span class="st">"dummy"</span><span class="op">)</span>       </span>
<span>            <span class="va">w</span><span class="op">$</span><span class="fu">action</span><span class="op">(</span>label<span class="op">=</span><span class="st">"buy"</span>, weights<span class="op">=</span><span class="op">-</span><span class="fl">100</span>, pr<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.7</span>,<span class="fl">0.3</span><span class="op">)</span>, id<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">1</span><span class="op">)</span>, end<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span>
<span>        <span class="va">w</span><span class="op">$</span><span class="fu">endState</span><span class="op">(</span><span class="op">)</span></span>
<span>    <span class="va">w</span><span class="op">$</span><span class="fu">endStage</span><span class="op">(</span><span class="op">)</span></span>
<span>    <span class="va">w</span><span class="op">$</span><span class="fu">stage</span><span class="op">(</span><span class="op">)</span>   <span class="co"># stage n=1</span></span>
<span>        <span class="va">w</span><span class="op">$</span><span class="fu">state</span><span class="op">(</span>label<span class="op">=</span><span class="st">"good"</span><span class="op">)</span>           </span>
<span>            <span class="va">w</span><span class="op">$</span><span class="fu">action</span><span class="op">(</span>label<span class="op">=</span><span class="st">"mt"</span>, weights<span class="op">=</span><span class="fl">55</span>, pr<span class="op">=</span><span class="fl">1</span>, id<span class="op">=</span><span class="fl">0</span>, end<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span>
<span>            <span class="va">w</span><span class="op">$</span><span class="fu">action</span><span class="op">(</span>label<span class="op">=</span><span class="st">"nmt"</span>, weights<span class="op">=</span><span class="fl">70</span>, pr<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.6</span>,<span class="fl">0.4</span><span class="op">)</span>, id<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">1</span><span class="op">)</span>, end<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span>
<span>        <span class="va">w</span><span class="op">$</span><span class="fu">endState</span><span class="op">(</span><span class="op">)</span></span>
<span>        <span class="va">w</span><span class="op">$</span><span class="fu">state</span><span class="op">(</span>label<span class="op">=</span><span class="st">"average"</span><span class="op">)</span>        </span>
<span>            <span class="va">w</span><span class="op">$</span><span class="fu">action</span><span class="op">(</span>label<span class="op">=</span><span class="st">"mt"</span>, weights<span class="op">=</span><span class="fl">40</span>, pr<span class="op">=</span><span class="fl">1</span>, id<span class="op">=</span><span class="fl">0</span>, end<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span>
<span>            <span class="va">w</span><span class="op">$</span><span class="fu">action</span><span class="op">(</span>label<span class="op">=</span><span class="st">"nmt"</span>, weights<span class="op">=</span><span class="fl">50</span>, pr<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.6</span>,<span class="fl">0.4</span><span class="op">)</span>, id<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">2</span><span class="op">)</span>, end<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span>
<span>        <span class="va">w</span><span class="op">$</span><span class="fu">endState</span><span class="op">(</span><span class="op">)</span></span>
<span>    <span class="va">w</span><span class="op">$</span><span class="fu">endStage</span><span class="op">(</span><span class="op">)</span></span>
<span>    <span class="va">w</span><span class="op">$</span><span class="fu">stage</span><span class="op">(</span><span class="op">)</span>   <span class="co"># stage n=2</span></span>
<span>        <span class="va">w</span><span class="op">$</span><span class="fu">state</span><span class="op">(</span>label<span class="op">=</span><span class="st">"good"</span><span class="op">)</span>          </span>
<span>            <span class="va">w</span><span class="op">$</span><span class="fu">action</span><span class="op">(</span>label<span class="op">=</span><span class="st">"mt"</span>, weights<span class="op">=</span><span class="fl">55</span>, pr<span class="op">=</span><span class="fl">1</span>, id<span class="op">=</span><span class="fl">0</span>, end<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span>
<span>            <span class="va">w</span><span class="op">$</span><span class="fu">action</span><span class="op">(</span>label<span class="op">=</span><span class="st">"nmt"</span>, weights<span class="op">=</span><span class="fl">70</span>, pr<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.5</span>,<span class="fl">0.5</span><span class="op">)</span>, id<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">1</span><span class="op">)</span>, end<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span>
<span>        <span class="va">w</span><span class="op">$</span><span class="fu">endState</span><span class="op">(</span><span class="op">)</span></span>
<span>        <span class="va">w</span><span class="op">$</span><span class="fu">state</span><span class="op">(</span>label<span class="op">=</span><span class="st">"average"</span><span class="op">)</span>       </span>
<span>            <span class="va">w</span><span class="op">$</span><span class="fu">action</span><span class="op">(</span>label<span class="op">=</span><span class="st">"mt"</span>, weights<span class="op">=</span><span class="fl">40</span>, pr<span class="op">=</span><span class="fl">1</span>, id<span class="op">=</span><span class="fl">0</span>, end<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span>
<span>            <span class="va">w</span><span class="op">$</span><span class="fu">action</span><span class="op">(</span>label<span class="op">=</span><span class="st">"nmt"</span>, weights<span class="op">=</span><span class="fl">50</span>, pr<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.5</span>,<span class="fl">0.5</span><span class="op">)</span>, id<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">2</span><span class="op">)</span>, end<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span>
<span>        <span class="va">w</span><span class="op">$</span><span class="fu">endState</span><span class="op">(</span><span class="op">)</span></span>
<span>        <span class="va">w</span><span class="op">$</span><span class="fu">state</span><span class="op">(</span>label<span class="op">=</span><span class="st">"not working"</span><span class="op">)</span>    </span>
<span>            <span class="va">w</span><span class="op">$</span><span class="fu">action</span><span class="op">(</span>label<span class="op">=</span><span class="st">"mt"</span>, weights<span class="op">=</span><span class="fl">30</span>, pr<span class="op">=</span><span class="fl">1</span>, id<span class="op">=</span><span class="fl">0</span>, end<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span>
<span>            <span class="va">w</span><span class="op">$</span><span class="fu">action</span><span class="op">(</span>label<span class="op">=</span><span class="st">"rep"</span>, weights<span class="op">=</span><span class="fl">5</span>, pr<span class="op">=</span><span class="fl">1</span>, id<span class="op">=</span><span class="fl">3</span>, end<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span>
<span>        <span class="va">w</span><span class="op">$</span><span class="fu">endState</span><span class="op">(</span><span class="op">)</span></span>
<span>    <span class="va">w</span><span class="op">$</span><span class="fu">endStage</span><span class="op">(</span><span class="op">)</span></span>
<span>    <span class="va">w</span><span class="op">$</span><span class="fu">stage</span><span class="op">(</span><span class="op">)</span>   <span class="co"># stage n=3</span></span>
<span>        <span class="va">w</span><span class="op">$</span><span class="fu">state</span><span class="op">(</span>label<span class="op">=</span><span class="st">"good"</span><span class="op">)</span>           </span>
<span>            <span class="va">w</span><span class="op">$</span><span class="fu">action</span><span class="op">(</span>label<span class="op">=</span><span class="st">"mt"</span>, weights<span class="op">=</span><span class="fl">55</span>, pr<span class="op">=</span><span class="fl">1</span>, id<span class="op">=</span><span class="fl">0</span>, end<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span>
<span>            <span class="va">w</span><span class="op">$</span><span class="fu">action</span><span class="op">(</span>label<span class="op">=</span><span class="st">"nmt"</span>, weights<span class="op">=</span><span class="fl">70</span>, pr<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.2</span>,<span class="fl">0.8</span><span class="op">)</span>, id<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">1</span><span class="op">)</span>, end<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span>
<span>        <span class="va">w</span><span class="op">$</span><span class="fu">endState</span><span class="op">(</span><span class="op">)</span></span>
<span>        <span class="va">w</span><span class="op">$</span><span class="fu">state</span><span class="op">(</span>label<span class="op">=</span><span class="st">"average"</span><span class="op">)</span>       </span>
<span>            <span class="va">w</span><span class="op">$</span><span class="fu">action</span><span class="op">(</span>label<span class="op">=</span><span class="st">"mt"</span>, weights<span class="op">=</span><span class="fl">40</span>, pr<span class="op">=</span><span class="fl">1</span>, id<span class="op">=</span><span class="fl">0</span>, end<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span>
<span>            <span class="va">w</span><span class="op">$</span><span class="fu">action</span><span class="op">(</span>label<span class="op">=</span><span class="st">"nmt"</span>, weights<span class="op">=</span><span class="fl">50</span>, pr<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.2</span>,<span class="fl">0.8</span><span class="op">)</span>, id<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">2</span><span class="op">)</span>, end<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span>
<span>        <span class="va">w</span><span class="op">$</span><span class="fu">endState</span><span class="op">(</span><span class="op">)</span></span>
<span>        <span class="va">w</span><span class="op">$</span><span class="fu">state</span><span class="op">(</span>label<span class="op">=</span><span class="st">"not working"</span><span class="op">)</span>    </span>
<span>            <span class="va">w</span><span class="op">$</span><span class="fu">action</span><span class="op">(</span>label<span class="op">=</span><span class="st">"mt"</span>, weights<span class="op">=</span><span class="fl">30</span>, pr<span class="op">=</span><span class="fl">1</span>, id<span class="op">=</span><span class="fl">0</span>, end<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span>
<span>            <span class="va">w</span><span class="op">$</span><span class="fu">action</span><span class="op">(</span>label<span class="op">=</span><span class="st">"rep"</span>, weights<span class="op">=</span><span class="fl">5</span>, pr<span class="op">=</span><span class="fl">1</span>, id<span class="op">=</span><span class="fl">3</span>, end<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span>
<span>        <span class="va">w</span><span class="op">$</span><span class="fu">endState</span><span class="op">(</span><span class="op">)</span></span>
<span>        <span class="va">w</span><span class="op">$</span><span class="fu">state</span><span class="op">(</span>label<span class="op">=</span><span class="st">"replaced"</span><span class="op">)</span>       </span>
<span>            <span class="va">w</span><span class="op">$</span><span class="fu">action</span><span class="op">(</span>label<span class="op">=</span><span class="st">"dummy"</span>, weights<span class="op">=</span><span class="fl">0</span>, pr<span class="op">=</span><span class="fl">1</span>, id<span class="op">=</span><span class="fl">3</span>, end<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span>
<span>        <span class="va">w</span><span class="op">$</span><span class="fu">endState</span><span class="op">(</span><span class="op">)</span></span>
<span>    <span class="va">w</span><span class="op">$</span><span class="fu">endStage</span><span class="op">(</span><span class="op">)</span></span>
<span>    <span class="va">w</span><span class="op">$</span><span class="fu">stage</span><span class="op">(</span><span class="op">)</span>   <span class="co"># stage n=4</span></span>
<span>        <span class="va">w</span><span class="op">$</span><span class="fu">state</span><span class="op">(</span>label<span class="op">=</span><span class="st">"good"</span>, end<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span>        </span>
<span>        <span class="va">w</span><span class="op">$</span><span class="fu">state</span><span class="op">(</span>label<span class="op">=</span><span class="st">"average"</span>, end<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span>     </span>
<span>        <span class="va">w</span><span class="op">$</span><span class="fu">state</span><span class="op">(</span>label<span class="op">=</span><span class="st">"not working"</span>, end<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span> </span>
<span>        <span class="va">w</span><span class="op">$</span><span class="fu">state</span><span class="op">(</span>label<span class="op">=</span><span class="st">"replaced"</span>, end<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span>   </span>
<span>    <span class="va">w</span><span class="op">$</span><span class="fu">endStage</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">w</span><span class="op">$</span><span class="fu">endProcess</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">w</span><span class="op">$</span><span class="fu">closeWriter</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;   Statistics:</span></span>
<span><span class="co">#&gt;     states : 14 </span></span>
<span><span class="co">#&gt;     actions: 18 </span></span>
<span><span class="co">#&gt;     weights: 1 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;   Closing binary MDP writer.</span></span></code></pre>
<p>Note that at each stage the states are numbered using index starting
from zero such that e.g.
<code>w$action(label="nmt", weights=50, pr=c(0.2,0.8), id=c(1,2), end=TRUE)</code>
define an action with transition to states with indices 1 and 2 at the
next stage with probability 0.2 and 0.8, respectively.</p>
<p>The MDP is illustrated in Figure 2. Each node corresponds to a
specific state. Node text are the state index (given stage) and its
label. A directed hyperarc is defined for each possible action. For
instance, action <code>mt</code> (maintain) corresponds to a
deterministic transition to state <code>good</code> and action
<code>nmt</code> (not maintain) corresponds to a transition to a
condition/state not better than the current condition/state. We buy the
machine in stage 1 and may choose to replace the machine during its
lifetime.</p>
<div class="figure" style="text-align: center">
<img src="building_files/figure-html/plotHgf3-1.png" alt="Figure 2: A finite-horizon MDP" width="864" style="max-width:100%;"><p class="caption">
Figure 2: A finite-horizon MDP
</p>
</div>
</div>
<div class="section level2">
<h2 id="an-infinite-horizon-hmdp">An infinite-horizon HMDP<a class="anchor" aria-label="anchor" href="#an-infinite-horizon-hmdp"></a>
</h2>
<p>A hierarchical MDP is an MDP with parameters defined in a special
way, but nevertheless in accordance with all usual rules and conditions
relating to such processes (<span class="citation">Kristensen and
Jørgensen (2000)</span>). The basic idea of the hierarchical structure
is that stages of the process can be expanded to a so-called <em>child
process</em>, which again may expand stages further to new child
processes leading to multiple levels. To illustrate consider the HMDP
shown in Figure 3. The process has three levels. At <code>Level 2</code>
we have a set of finite-horizon semi-MDPs (one for each oval box) which
all can be represented using a state-expanded hypergraph (hyperarcs not
shown, only hyperarcs connecting processes are shown). A semi-MDP at
<code>Level 2</code> is uniquely defined by a given state <span class="math inline">\(s\)</span> and action <span class="math inline">\(a\)</span> of its <em>parent process</em> at
<code>Level 1</code> (illustrated by the arcs with head and tail node at
<code>Level 1</code> and <code>Level 2</code>, respectively). Moreover,
when a child process at <code>Level 2</code> terminates a transition
from a state <span class="math inline">\(s\in \mathcal{S}_{N}\)</span>
of the child process to a state at the next stage of the parent process
occur (illustrated by the (hyper)arcs having head and tail at
<code>Level 2</code> and <code>Level 1</code>, respectively).</p>
<div class="figure" style="text-align: center">
<img src="vignette_files/hmdp_index.png" alt="Figure 3: The state-expanded hypergraph of the first stage of a hierarchical MDP. Level 0 indicate the founder level, and the nodes indicates states at the different levels. A child process (oval box) is represented using its state-expanded hypergraph (hyperarcs not shown) and is uniquely defined by a given state and action of its parent process." style="max-width:100%;"><p class="caption">
Figure 3: The state-expanded hypergraph of the first stage of a
hierarchical MDP. Level 0 indicate the founder level, and the nodes
indicates states at the different levels. A child process (oval box) is
represented using its state-expanded hypergraph (hyperarcs not shown)
and is uniquely defined by a given state and action of its parent
process.
</p>
</div>
<p>Since a child process is always defined by a stage, state and action
of the parent process we have that for instance a state at Level 1 can
be identified using an index vector <span class="math inline">\(\nu=(n_{0},s_{0},a_{0},n_{1},s_{1})\)</span> where
<span class="math inline">\(s_1\)</span> is the state id at the given
stage <span class="math inline">\(n_1\)</span> in the process defined by
the action <span class="math inline">\(a_0\)</span> in state <span class="math inline">\(s_0\)</span> at stage <span class="math inline">\(n_0\)</span>. Note all values are ids starting
from zero, e.g. if <span class="math inline">\(s_1=0\)</span> it is the
first state at the corresponding stage and if <span class="math inline">\(a_0=2\)</span> it is the third action at the
corresponding state. In general a state <span class="math inline">\(s\)</span> and action <span class="math inline">\(a\)</span> at level <span class="math inline">\(l\)</span> can be uniquely identified using <span class="math display">\[
\begin{aligned}
\nu_{s}&amp;=(n_{0},s_{0},a_{0},n_{1},s_{1},\ldots,n_{l},s_{l}) \\
\nu_{a}&amp;=(n_{0},s_{0},a_{0},n_{1},s_{1},\ldots,n_{l},s_{l},a_{l}).
\end{aligned}
\]</span> The index vectors for state <span class="math inline">\(v_0\)</span>, <span class="math inline">\(v_1\)</span> and <span class="math inline">\(v_2\)</span> are illustrated in Figure 3.
<!-- As under a semi-MDP another way to identify a state in the state-expanded hypergraph is using an unique id.  --></p>
<p>Let us try to solve a small problem from livestock farming, namely
the cow replacement problem where we want to represent the age of the
cow, i.e. the lactation number of the cow. During a lactation a cow may
have a high, average or low yield. We assume that a cow is always
replaced after 4 lactations.</p>
<p>In addition to lactation and milk yield we also want to take the
genetic merit into account which is either bad, average or good. When a
cow is replaced we assume that the probability of a bad, average or good
heifer is the same.</p>
<p>We formulate the problem as a HMDP with 2 levels. At level 0 the
states are the genetic merit and the length of a stage is a life of a
cow. At level 1 a stage describe a lactation and states describe the
yield. Decisions at level 1 are <code>keep</code> or
<code>replace</code>.</p>
<p>Note the MDP runs over an infinite time-horizon at the founder level
where each state (genetic merit) define a semi-MDP at level 1 with 4
lactations.</p>
<p>To generate the MDP we need to know the weights and transition
probabilities which are provided in a CSV file. To ease the
understanding we provide 2 functions for reading from the CSV:</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://magrittr.tidyverse.org" class="external-link">magrittr</a></span><span class="op">)</span></span>
<span><span class="va">cowDf</span> <span class="op">&lt;-</span> <span class="fu">readr</span><span class="fu">::</span><span class="fu"><a href="https://readr.tidyverse.org/reference/read_delim.html" class="external-link">read_csv</a></span><span class="op">(</span><span class="st">"vignette_files/cow.csv"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt; <span style="font-weight: bold;">Rows: </span><span style="color: #0000BB;">66</span> <span style="font-weight: bold;">Columns: </span><span style="color: #0000BB;">16</span></span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">──</span> <span style="font-weight: bold;">Column specification</span> <span style="color: #00BBBB;">──────────────────────────────────────────────────────────────────</span></span></span>
<span><span class="co">#&gt; <span style="font-weight: bold;">Delimiter:</span> ","</span></span>
<span><span class="co">#&gt; <span style="color: #BB0000;">chr</span>  (1): label</span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">dbl</span> (15): s0, n1, s1, Duration, Reward, Output, scp0, idx0, pr0, scp1, idx1, pr1, scp2...</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> Use `spec()` to retrieve the full column specification for this data.</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> Specify the column types or set `show_col_types = FALSE` to quiet this message.</span></span></code></pre>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cowDf</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 66 × 16</span></span></span>
<span><span class="co">#&gt;       s0    n1    s1 label Durat…¹ Reward Output  scp0  idx0   pr0  scp1  idx1   pr1  scp2</span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span>     0     0     0 Dummy       0      0      0     1     0 0.333     1     1 0.333     1</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span>     0     1     0 Keep        1   <span style="text-decoration: underline;">6</span>000   <span style="text-decoration: underline;">3</span>000     1     0 0.6       1     1 0.3       1</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span>     0     1     0 Repl…       1   <span style="text-decoration: underline;">5</span>000   <span style="text-decoration: underline;">3</span>000     0     0 0.333     0     1 0.333     0</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span>     0     1     1 Keep        1   <span style="text-decoration: underline;">8</span>000   <span style="text-decoration: underline;">4</span>000     1     0 0.2       1     1 0.6       1</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span>     0     1     1 Repl…       1   <span style="text-decoration: underline;">7</span>000   <span style="text-decoration: underline;">4</span>000     0     0 0.333     0     1 0.333     0</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span>     0     1     2 Keep        1  <span style="text-decoration: underline;">10</span>000   <span style="text-decoration: underline;">5</span>000     1     0 0.1       1     1 0.3       1</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span>     0     1     2 Repl…       1   <span style="text-decoration: underline;">9</span>000   <span style="text-decoration: underline;">5</span>000     0     0 0.333     0     1 0.333     0</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span>     0     2     0 Keep        1   <span style="text-decoration: underline;">8</span>000   <span style="text-decoration: underline;">4</span>000     1     0 0.6       1     1 0.3       1</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span>     0     2     0 Repl…       1   <span style="text-decoration: underline;">7</span>000   <span style="text-decoration: underline;">4</span>000     0     0 0.333     0     1 0.333     0</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span>     0     2     1 Keep        1  <span style="text-decoration: underline;">10</span>000   <span style="text-decoration: underline;">5</span>000     1     0 0.2       1     1 0.6       1</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># … with 56 more rows, 2 more variables: idx2 &lt;dbl&gt;, pr2 &lt;dbl&gt;, and abbreviated variable</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;">#   name ¹​Duration</span></span></span></code></pre>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Weights given a state at level 2</span></span>
<span><span class="va">lev1W</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">s0Idx</span>, <span class="va">n1Idx</span>, <span class="va">s1Idx</span>, <span class="va">a1Lbl</span><span class="op">)</span> <span class="op">{</span></span>
<span>   <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">cowDf</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>      <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">s0</span> <span class="op">==</span> <span class="va">s0Idx</span> <span class="op">&amp;</span> <span class="va">n1</span> <span class="op">==</span> <span class="va">n1Idx</span> <span class="op">&amp;</span> <span class="va">s1</span> <span class="op">==</span> <span class="va">s1Idx</span> <span class="op">&amp;</span> <span class="va">label</span> <span class="op">==</span> <span class="va">a1Lbl</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>      <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">Duration</span>, <span class="va">Reward</span>, <span class="va">Output</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="op">)</span></span>
<span>   <span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="fu">lev1W</span><span class="op">(</span><span class="fl">2</span>, <span class="fl">2</span>, <span class="fl">1</span>, <span class="st">'Keep'</span><span class="op">)</span>     <span class="co"># good genetic merit, lactation 2, avg yield, keep action</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt; [1]     1 14000  7000</span></span></code></pre>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Trans pr given a state at level 2</span></span>
<span><span class="va">lev1Pr</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">s0Idx</span>, <span class="va">n1Idx</span>, <span class="va">s1Idx</span>, <span class="va">a1Lbl</span><span class="op">)</span> <span class="op">{</span></span>
<span>   <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">cowDf</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>      <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">s0</span> <span class="op">==</span> <span class="va">s0Idx</span> <span class="op">&amp;</span> <span class="va">n1</span> <span class="op">==</span> <span class="va">n1Idx</span> <span class="op">&amp;</span> <span class="va">s1</span> <span class="op">==</span> <span class="va">s1Idx</span> <span class="op">&amp;</span> <span class="va">label</span> <span class="op">==</span> <span class="va">a1Lbl</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>      <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">scp0</span><span class="op">:</span><span class="fu">last_col</span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="op">)</span></span>
<span>   <span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="fu">lev1Pr</span><span class="op">(</span><span class="fl">2</span>, <span class="fl">2</span>, <span class="fl">1</span>, <span class="st">'Replace'</span><span class="op">)</span> <span class="co"># good genetic merit, lactation 2, avg yield, replace action</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt; [1] 0.0000000 0.0000000 0.3333333 0.0000000 1.0000000 0.3333333 0.0000000 2.0000000</span></span>
<span><span class="co">#&gt; [9] 0.3333333</span></span></code></pre>
<p>We can now generate the model with three weights</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">lblS0</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'Bad genetic level'</span>, <span class="st">'Avg genetic level'</span>, <span class="st">'Good genetic level'</span><span class="op">)</span></span>
<span><span class="va">lblS1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'Low yield'</span>, <span class="st">'Avg yield'</span>, <span class="st">'High yield'</span><span class="op">)</span></span>
<span><span class="va">prefix</span><span class="op">&lt;-</span><span class="st">"cow_"</span></span>
<span><span class="va">w</span><span class="op">&lt;-</span><span class="fu"><a href="../reference/binaryMDPWriter.html">binaryMDPWriter</a></span><span class="op">(</span><span class="va">prefix</span><span class="op">)</span></span>
<span><span class="va">w</span><span class="op">$</span><span class="fu">setWeights</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Duration"</span>, <span class="st">"Net reward"</span>, <span class="st">"Yield"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">w</span><span class="op">$</span><span class="fu">process</span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="va">w</span><span class="op">$</span><span class="fu">stage</span><span class="op">(</span><span class="op">)</span>   <span class="co"># stage 0 at founder level</span></span>
<span>    <span class="kw">for</span> <span class="op">(</span><span class="va">s0</span> <span class="kw">in</span> <span class="fl">0</span><span class="op">:</span><span class="fl">2</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">w</span><span class="op">$</span><span class="fu">state</span><span class="op">(</span>label<span class="op">=</span><span class="va">lblS0</span><span class="op">[</span><span class="va">s0</span><span class="op">+</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span>   <span class="co"># state at founder</span></span>
<span>        <span class="va">w</span><span class="op">$</span><span class="fu">action</span><span class="op">(</span>label<span class="op">=</span><span class="st">"Keep"</span>, weights<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">0</span><span class="op">)</span>, prob<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>,<span class="fl">0</span>,<span class="fl">1</span><span class="op">)</span><span class="op">)</span>   <span class="co"># action at founder</span></span>
<span>          <span class="va">w</span><span class="op">$</span><span class="fu">process</span><span class="op">(</span><span class="op">)</span></span>
<span>            <span class="va">w</span><span class="op">$</span><span class="fu">stage</span><span class="op">(</span><span class="op">)</span>   <span class="co"># dummy stage at level 1</span></span>
<span>               <span class="va">w</span><span class="op">$</span><span class="fu">state</span><span class="op">(</span>label<span class="op">=</span><span class="st">"Dummy"</span><span class="op">)</span></span>
<span>                 <span class="va">w</span><span class="op">$</span><span class="fu">action</span><span class="op">(</span>label<span class="op">=</span><span class="st">"Dummy"</span>, weights<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">0</span><span class="op">)</span>, </span>
<span>                          prob<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">0</span>,<span class="fl">1</span><span class="op">/</span><span class="fl">3</span>, <span class="fl">1</span>,<span class="fl">1</span>,<span class="fl">1</span><span class="op">/</span><span class="fl">3</span>, <span class="fl">1</span>,<span class="fl">2</span>,<span class="fl">1</span><span class="op">/</span><span class="fl">3</span><span class="op">)</span>, end<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span>
<span>               <span class="va">w</span><span class="op">$</span><span class="fu">endState</span><span class="op">(</span><span class="op">)</span></span>
<span>            <span class="va">w</span><span class="op">$</span><span class="fu">endStage</span><span class="op">(</span><span class="op">)</span></span>
<span>            <span class="kw">for</span> <span class="op">(</span><span class="va">d1</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">4</span><span class="op">)</span> <span class="op">{</span></span>
<span>              <span class="va">w</span><span class="op">$</span><span class="fu">stage</span><span class="op">(</span><span class="op">)</span>   <span class="co"># stage at level 1</span></span>
<span>                <span class="kw">for</span> <span class="op">(</span><span class="va">s1</span> <span class="kw">in</span> <span class="fl">0</span><span class="op">:</span><span class="fl">2</span><span class="op">)</span> <span class="op">{</span></span>
<span>                  <span class="va">w</span><span class="op">$</span><span class="fu">state</span><span class="op">(</span>label<span class="op">=</span><span class="va">lblS1</span><span class="op">[</span><span class="va">s1</span><span class="op">+</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span></span>
<span>                    <span class="kw">if</span> <span class="op">(</span><span class="va">d1</span><span class="op">!=</span><span class="fl">4</span><span class="op">)</span> <span class="op">{</span></span>
<span>                      <span class="va">w</span><span class="op">$</span><span class="fu">action</span><span class="op">(</span>label<span class="op">=</span><span class="st">"Keep"</span>, weights<span class="op">=</span><span class="fu">lev1W</span><span class="op">(</span><span class="va">s0</span>,<span class="va">d1</span>,<span class="va">s1</span>,<span class="st">"Keep"</span><span class="op">)</span>, </span>
<span>                               prob<span class="op">=</span><span class="fu">lev1Pr</span><span class="op">(</span><span class="va">s0</span>,<span class="va">d1</span>,<span class="va">s1</span>,<span class="st">"Keep"</span><span class="op">)</span>, end<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span>
<span>                    <span class="op">}</span></span>
<span>                    <span class="va">w</span><span class="op">$</span><span class="fu">action</span><span class="op">(</span>label<span class="op">=</span><span class="st">"Replace"</span>, weights<span class="op">=</span><span class="fu">lev1W</span><span class="op">(</span><span class="va">s0</span>,<span class="va">d1</span>,<span class="va">s1</span>,<span class="st">"Replace"</span><span class="op">)</span>, </span>
<span>                             prob<span class="op">=</span><span class="fu">lev1Pr</span><span class="op">(</span><span class="va">s0</span>,<span class="va">d1</span>,<span class="va">s1</span>,<span class="st">"Replace"</span><span class="op">)</span>, end<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span>
<span>                  <span class="va">w</span><span class="op">$</span><span class="fu">endState</span><span class="op">(</span><span class="op">)</span></span>
<span>                <span class="op">}</span></span>
<span>              <span class="va">w</span><span class="op">$</span><span class="fu">endStage</span><span class="op">(</span><span class="op">)</span></span>
<span>            <span class="op">}</span></span>
<span>          <span class="va">w</span><span class="op">$</span><span class="fu">endProcess</span><span class="op">(</span><span class="op">)</span></span>
<span>        <span class="va">w</span><span class="op">$</span><span class="fu">endAction</span><span class="op">(</span><span class="op">)</span></span>
<span>      <span class="va">w</span><span class="op">$</span><span class="fu">endState</span><span class="op">(</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="va">w</span><span class="op">$</span><span class="fu">endStage</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">w</span><span class="op">$</span><span class="fu">endProcess</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">w</span><span class="op">$</span><span class="fu">closeWriter</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;   Statistics:</span></span>
<span><span class="co">#&gt;     states : 42 </span></span>
<span><span class="co">#&gt;     actions: 69 </span></span>
<span><span class="co">#&gt;     weights: 3 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;   Closing binary MDP writer.</span></span></code></pre>
<p>Note that the model is built using the <code>prob</code> parameter
which contains triples of <code>(scope, id, pr)</code>. Scope can be: 2
= a transition to a child process (stage zero in the child process), 1 =
a transition to next stage in the current process and 0 = a transition
to the next stage in the father process. For instance if
<code>prob = c(1,2,0.3, 0,0,0.7)</code> we specify transitions to the
third state (id = 2) at the next stage of the process and to the first
state (id = 0) at the next stage of the father process with
probabilities 0.3 and 0.7, respectively.</p>
<p>A plot of the state-expanded hypergraph is given below where action
<code>keep</code> is drawn with orange color and action
<code>replace</code> with blue color.</p>
<p><img src="building_files/figure-html/plotHMDP-1.png" width="864" style="max-width:100%;"></p>
</div>
<div class="section level2 unnumbered">
<h2 class="unnumbered" id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
<div id="refs" class="references csl-bib-body hanging-indent">
<div id="ref-Kristensen00" class="csl-entry">
Kristensen, A. R., and E. Jørgensen. 2000. <span>“Multi-Level Hierarchic
<span>M</span>arkov Processes as a Framework for Herd Management
Support.”</span> <em>Annals of Operations Research</em> 94: 69–89. <a href="https://doi.org/10.1023/A:1018921201113" class="external-link">https://doi.org/10.1023/A:1018921201113</a>.
</div>
<div id="ref-Relund06" class="csl-entry">
Nielsen, L. R., and A. R. Kristensen. 2006. <span>“Finding the
<span><span class="math inline">\(K\)</span></span> Best Policies in a
Finite-Horizon <span>M</span>arkov Decision Process.”</span>
<em>European Journal of Operational Research</em> 175 (2): 1164–79. <a href="https://doi.org/10.1016/j.ejor.2005.06.011" class="external-link">https://doi.org/10.1016/j.ejor.2005.06.011</a>.
</div>
<div id="ref-Tijms03" class="csl-entry">
Tijms, Henk. C. 2003. <em>A First Course in Stochastic Models</em>. John
Wiley &amp; Sons Ltd.
</div>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Lars Relund Nielsen.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
